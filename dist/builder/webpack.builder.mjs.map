{
  "version": 3,
  "sources": ["../../src/builder/webpack.builder.mts"],
  "sourcesContent": ["/*\n * Copyright (c) 2022 Kiyozz.\n *\n * All rights reserved.\n */\n\nimport type { Compiler, Configuration } from 'webpack'\nimport type WebpackDevServer from 'webpack-dev-server'\n\nimport type { Item } from '../config/config.mjs'\nimport { Logger } from '../console.mjs'\nimport { ConfigurationError } from '../errors/configuration-error.mjs'\nimport { BaseBuilder } from './base.builder.mjs'\n\nconst _logger = new Logger('Builder/Webpack')\n\nexport class WebpackBuilder extends BaseBuilder<Configuration> {\n  readonly hasInitialBuild = false\n\n  private readonly _rendererServer: WebpackDevServer\n  private readonly _compiler!: Compiler\n\n  static async create(config: Item<Configuration>): Promise<WebpackBuilder> {\n    try {\n      const webpack = (await import('webpack')).default\n      const WebpackDevServer = (await import('webpack-dev-server')).default // check that user can use webpack-dev-server\n      const compiler = webpack(config.config)\n      const rendererServer = new WebpackDevServer(\n        {\n          port: 9080,\n          hot: true,\n          client: {\n            overlay: true,\n          },\n        },\n        compiler,\n      )\n\n      return new WebpackBuilder(config, { compiler, rendererServer })\n    } catch (err) {\n      if (err instanceof Error) {\n        if (\n          err.message?.includes('Invalid configuration object') &&\n          err.message?.includes('ValidationError')\n        ) {\n          _logger.end(\n            'Your webpack configuration is invalid. Message from webpack',\n            err.message,\n          )\n        }\n\n        if (err.message?.includes('MODULE_NOT_FOUND')) {\n          _logger.end(\n            \"It looks like you're trying to use webpack but it's not installed, try running `npm i -D webpack webpack-dev-server`\",\n          )\n        }\n      }\n\n      _logger.end(\n        'An unknown error occurred while trying to configure webpack',\n        err,\n      )\n      process.exit(1)\n    }\n  }\n\n  constructor(\n    protected readonly _config: Item<Configuration>,\n    {\n      compiler,\n      rendererServer,\n    }: { compiler: Compiler; rendererServer: WebpackDevServer },\n  ) {\n    super(_config)\n\n    this._compiler = compiler\n    this._rendererServer = rendererServer\n  }\n\n  build(): Promise<void> {\n    _logger.log('Building', this.env.toLowerCase())\n\n    return new Promise<void>((resolve, reject) => {\n      if ((this._compiler as unknown as { running: boolean }).running) {\n        resolve()\n        return\n      }\n\n      this._compiler.run((err) => {\n        if (err) {\n          _logger.error(this.env, 'error', err)\n          reject(err)\n        } else {\n          _logger.log(this.env, 'built')\n          resolve()\n        }\n      })\n    })\n  }\n\n  async dev(): Promise<void> {\n    if (this._config.isMain) {\n      throw new ConfigurationError(\n        'mainConfig.type: webpack is not supported yet.',\n      )\n    }\n\n    try {\n      await this._rendererServer.start()\n    } catch (e) {\n      if (e instanceof Error) {\n        _logger.end(this.env, 'WDS error', e)\n      } else {\n        _logger.log(this.env, 'WDS starting')\n      }\n    }\n  }\n}\n"],
  "mappings": "AAUA;AACA;AACA;AAEA,MAAM,UAAU,IAAI,OAAO,iBAAiB;AAErC,MAAM,uBAAuB,YAA2B;AAAA,EAkD7D,YACqB,SACnB;AAAA,IACE;AAAA,IACA;AAAA,KAEF;AACA,UAAM,OAAO;AANM;AAlDZ,2BAAkB;AA0DzB,SAAK,YAAY;AACjB,SAAK,kBAAkB;AAAA,EACzB;AAAA,eAvDa,OAAO,QAAsD;AAtB5E;AAuBI,QAAI;AACF,YAAM,UAAW,OAAM,OAAO,YAAY;AAC1C,YAAM,mBAAoB,OAAM,OAAO,uBAAuB;AAC9D,YAAM,WAAW,QAAQ,OAAO,MAAM;AACtC,YAAM,iBAAiB,IAAI,iBACzB;AAAA,QACE,MAAM;AAAA,QACN,KAAK;AAAA,QACL,QAAQ;AAAA,UACN,SAAS;AAAA,QACX;AAAA,MACF,GACA,QACF;AAEA,aAAO,IAAI,eAAe,QAAQ,EAAE,UAAU,eAAe,CAAC;AAAA,IAChE,SAAS,KAAP;AACA,UAAI,eAAe,OAAO;AACxB,YACE,WAAI,YAAJ,mBAAa,SAAS,oCACtB,WAAI,YAAJ,mBAAa,SAAS,qBACtB;AACA,kBAAQ,IACN,+DACA,IAAI,OACN;AAAA,QACF;AAEA,YAAI,UAAI,YAAJ,mBAAa,SAAS,qBAAqB;AAC7C,kBAAQ,IACN,sHACF;AAAA,QACF;AAAA,MACF;AAEA,cAAQ,IACN,+DACA,GACF;AACA,cAAQ,KAAK,CAAC;AAAA,IAChB;AAAA,EACF;AAAA,EAeA,QAAuB;AACrB,YAAQ,IAAI,YAAY,KAAK,IAAI,YAAY,CAAC;AAE9C,WAAO,IAAI,QAAc,CAAC,SAAS,WAAW;AAC5C,UAAK,KAAK,UAA8C,SAAS;AAC/D,gBAAQ;AACR;AAAA,MACF;AAEA,WAAK,UAAU,IAAI,CAAC,QAAQ;AAC1B,YAAI,KAAK;AACP,kBAAQ,MAAM,KAAK,KAAK,SAAS,GAAG;AACpC,iBAAO,GAAG;AAAA,QACZ,OAAO;AACL,kBAAQ,IAAI,KAAK,KAAK,OAAO;AAC7B,kBAAQ;AAAA,QACV;AAAA,MACF,CAAC;AAAA,IACH,CAAC;AAAA,EACH;AAAA,QAEM,MAAqB;AACzB,QAAI,KAAK,QAAQ,QAAQ;AACvB,YAAM,IAAI,mBACR,gDACF;AAAA,IACF;AAEA,QAAI;AACF,YAAM,KAAK,gBAAgB,MAAM;AAAA,IACnC,SAAS,GAAP;AACA,UAAI,aAAa,OAAO;AACtB,gBAAQ,IAAI,KAAK,KAAK,aAAa,CAAC;AAAA,MACtC,OAAO;AACL,gBAAQ,IAAI,KAAK,KAAK,cAAc;AAAA,MACtC;AAAA,IACF;AAAA,EACF;AACF;",
  "names": []
}
